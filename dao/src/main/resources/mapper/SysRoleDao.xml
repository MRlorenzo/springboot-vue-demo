<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one or more
  ~ contributor license agreements.  See the NOTICE file distributed with
  ~ this work for additional information regarding copyright ownership.
  ~ The ASF licenses this file to You under the Apache License, Version 2.0
  ~ (the "License"); you may not use this file except in compliance with
  ~ the License.  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.spmul.dao.shiro.SysRoleDao">
	<cache-ref namespace="org.spmul.dao.shiro.SysRoleDao"/>
	<cache readOnly="true"/>


	<resultMap id="sysRoleMap" type="org.spmul.entity.shiro.SysRoleEntity">
		<result property="roleId" column="role_id"/>
		<result property="roleName" column="role_name"/>
		<result property="enName" column="en_name"/>
		<result property="remark" column="remark"/>
		<result property="createUserId" column="create_user_id"/>
		<result property="createTime" column="create_time"/>
		<result property="webSocketParams" column="websocket_params"/>
		<result property="isShift" column="is_shift"/>
		<result property="isDel" column="is_del"/>
		<result property="departmentId" column="department_id"/>
		<result property="sort" column="sort"/>
	</resultMap>

	<resultMap id="allInfo" type="org.spmul.entity.shiro.SysRoleEntity" extends="sysRoleMap">
		<association property="departmentInfo" column="department_id" select="org.spmul.dao.shiro.DepartmentDao.queryObject"/>
	</resultMap>


	<select id="queryObject" resultMap="allInfo">
		select * from sys_role where role_id = #{value} and is_del=0
	</select>

	<sql id="queryListWhereSql">
		where is_del = 0
		<if test="roleName != null and roleName.trim() != ''">
			and `role_name` like concat('%',#{roleName},'%')
		</if>
		<if test="enName != null and enName.trim() !=''">
			and `en_name` like concat('%',#{enName} , '%')
		</if>
		<if test="createUserId != null">
			and create_user_id = #{createUserId}
		</if>
		<if test="isShift != null">
			and is_shift = #{isShift}
		</if>
		<if test="departmentId != null and departmentId != '' ">
			and department_id = #{departmentId}
		</if>
		<if test="roleFiltering != null">
			AND sort > ( SELECT MIN(sort) FROM sys_role WHERE role_id = #{roleFiltering} )
		</if>
	</sql>

	<select id="queryList" resultMap="allInfo">
		select * from sys_role
		<include refid="queryListWhereSql"/>
		<choose>
			<when test="sidx != null and sidx.trim() != ''">
				order by ${sidx} ${order}
			</when>
			<otherwise>
				order by sort asc
			</otherwise>
		</choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>

	<select id="queryTotal" resultType="int">
		select count(*) from sys_role
		<include refid="queryListWhereSql"/>
	</select>

	<select id="findWebSocketParamsByUserId" parameterType="long" resultType="string">
		SELECT
			GROUP_CONCAT(websocket_params)
		FROM
			sys_user_role sur,
			sys_role sr
		WHERE
			sur.role_id = sr.role_id
		AND user_id = #{id} and sr.is_del=0;
	</select>

	<insert id="save" parameterType="org.spmul.entity.shiro.SysRoleEntity" useGeneratedKeys="true" keyProperty="roleId">
		insert into sys_role
		(
			`role_id`,
			`role_name`,
			`en_name`,
			`remark`,
			`create_user_id`,
			`create_time`,
			`websocket_params`,
			`is_shift`,
			`is_del`,
			`department_id`,
			`sort`
		)
		values
		(
			#{roleId},
			#{roleName},
			#{enName},
			#{remark},
			#{createUserId},
			#{createTime},
			#{webSocketParams},
			#{isShift},
			#{isDel},
			#{departmentId},
			#{sort}
		)
	</insert>

	<update id="update" parameterType="org.spmul.entity.shiro.SysRoleEntity">
		update sys_role
		<set>
			<if test="roleName != null">`role_name` = #{roleName}, </if>
			<if test="enName != null">`en_name` = #{enName}, </if>
			<if test="remark != null">`remark` = #{remark} ,</if>
			<if test="webSocketParams!=null">`websocket_params` = #{webSocketParams},</if>
			<if test="isShift!=null">`is_shift` = #{isShift},</if>
			<if test="isDel!=null">`is_del` = #{isDel},</if>
			<if test="departmentId!=null">`department_id` = #{departmentId},</if>
			<if test="sort!=null">`sort` = #{sort}</if>
		</set>
		where role_id = #{roleId}
	</update>

	<!--<delete id="deleteBatch">
		delete from sys_role where role_id in
		<foreach item="roleId" collection="array" open="(" separator="," close=")">
			#{roleId}
		</foreach>
		;
		delete from sys_role_menu where role_id in
		<foreach item="roleId" collection="array" open="(" separator="," close=")">
			#{roleId}
		</foreach>
		;
		delete from sys_user_role where role_id in
		<foreach item="roleId" collection="array" open="(" separator="," close=")">
			#{roleId}
		</foreach>
	</delete>-->

	<update id="deleteBatch">
		update sys_role  set is_del=1 where role_id in
		<foreach item="roleId" collection="array" open="(" separator="," close=")">
			#{roleId}
		</foreach>
	</update>

	<!-- 查询用户创建的角色ID列表 -->
	<select id="queryRoleIdList" resultType="long">
		select role_id from sys_role where create_user_id = #{createUserId}  and is_del=0
	</select>

	<!-- 查询用户创建的角色ID列表 -->
	<select id="queryRoleIdListByUserId" resultType="long">
		SELECT DISTINCT b.role_id
		FROM
			sys_user_role a,
			sys_role b
		WHERE
			a.role_id = b.role_id AND user_id = #{userId}
		ORDER BY b.sort
	</select>

	<select id="queryBatchByUserId" resultType="org.spmul.entity.shiro.SysRoleEntity">
		select * from sys_role where role_id in (
		select role_id from sys_user_role where user_id=#{userId}
		)
		and is_del=0 order by sort asc
	</select>


	<select id="queryListByDepartmentId" resultType="org.spmul.entity.shiro.SysRoleEntity">
		select * from sys_role where department_id=#{departmentId} and is_del=0 ORDER BY  sort ASC
	</select>


	<select id="queryByString" resultType="org.spmul.entity.shiro.SysRoleEntity">
		select * from sys_role where role_name=#{value} or en_name=#{value}
	</select>

</mapper>
